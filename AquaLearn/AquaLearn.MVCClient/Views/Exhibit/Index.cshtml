@model AquaLearn.MVCClient.Models.ExhibitModel

@{
    ViewData["Title"] = "Exhibit";
}

<h1>Habitat</h1>

<style>
  figure {
    display: inline-block;
    text-align: center;
    justify-content: center;
    border: 2px solid #aaaaaa;
    width: 65%;
    margin-left: 195px;
  }

  article {
    border: 2px solid #aaaaaa;
  }
</style>

<div>
    <div>
        <button type="button" onclick="changeExhibit(this.id)" id="_DeepOcean">Deep Sea</button>
        <button type="button" onclick="changeExhibit(this.id)" id="_CoralReef">Coral Reef</button>
        <button type="button" onclick="changeExhibit(this.id)" id="_Pollution">Pollution</button>
    </div>

    <div id="placeholder">
      <div style="display:flex; justify-content:center;">
        <canvas id="myCanvas" width="720" height="480" style="border:1px solid #000000;"></canvas>
      </div>
      <figure>
        <article>
          <h2>
            lorem ipsum
          </h2>
        </article>
        <article>
          <h3>
            lorem
          </h3>
        </article>
      </figure>
    </div>
</div>

<script type="text/javascript">
    // *******************
    // MAIN
    // *******************

    // INITIALIZE

    // C# to JS conversion

    var fishNames = [];
    var fishDescriptions = [];
    var fishSchooling = [];

    @foreach (var fish in Model.Fishes)
    {
        @:fishNames.push("@fish.Name");
        @:fishDescriptions.push("@fish.Description");
        @:fishSchooling.push("@fish.Schooling");
    }

    var plantNames = [];
    var plantDescriptions = [];
    @foreach (var plant in Model.Plants)
    {
        @:plantNames.push(@plant.Name);
        @:plantDescriptions.push(@plant.Description);
    }

    var trashNames = [];
    var trashDescriptions = [];
    @foreach (var trash in Model.Trash)
    {
        @:trashNames.push(@trash.Name);
        @:trashDescriptions.push(@trash.Description);
    }

    // JS INIT

    var fishSpriteSheet = foreach;
    fishSpriteSheet.src = "@Url.Content("~/images/fishSpriteSheet.png")";
    var vector3Destinations = [];
    var vector3Current = [0, 0, 0];
    var numFish = getRandomIntRange(3, 15);
    var numPlants = getRandomIntRange(5, 10);
    var fishes = [];
    var fishesMove = [];
    var trash = [];
    var school = [];
    var plants = [];
    var schooling = getRandomIntRange(0, 2);
    var direction = ['l', 'r'];

    // Move Speed of fish
    var MoveSpeed = 1;
    var canvasHeight = 480;
    var canvasWidth = 720;
    var boundary = 100;
    // Canvas init
    var last = new Date();
    var myGameArea = draw();
    var ctx = getContext();
    var schoolingVector3 = setRndVector3();
    var exhibitType = "_DeepOcean"

    init();
    setInterval(function () { update(); }, 17);

    function init() {
        // Init Fish
        for (var i = 0; i <= numFish; i++) {
            schooling = getRandomIntRange(0, 2);
            // add fish to fishes
            if (schooling == 0) {
                vector3Current = setRndVector3();
                fishes.push(vector3Current);
            }
            else {
                if (schoolingVector3 == null) {
                    vector3Current = setRndVector3();
                    schoolingVector3 = vector3Current;
                }
                else {
                    vector3Current = schoolingVector3;
                }
                school.push(vector3Current);
            }

            fishesMove.push(direction[0]);
            vector3Destinations.push([0,0,0]);
        }

        // Init Plants
        for (var i = 0; i <= numPlants; i++) {
            plants.push(setPlantDestination());
        }
    }

    // UPDATE

    function update() {
        clear();
        place();
    }

    function clear() {
        ctx.clearRect(0, 0, 720, 480);
    }

    function place() {
        var regColor;
        var schoolColor;
        var plantColor;

        switch (exhibitType) {
            case "_CoralReef":
                regColor = "blue";
                schoolColor = "black";
                plantColor = "green";
                break;
            case "_DeepOcean":
                regColor = "red";
                schoolColor = "purple";
                plantColor = "lime";
                break;
            default:
                regColor = "brown";
                schoolColor = "grey";
                plantColor = "black";
                break;
        }

        drawBackground();

        for (var i = 0; i < fishes.length; i++) {
            fishes[i] = swim(i, fishes[i][0], fishes[i][1], fishes[i][2]);
            // currFish setup [name, startx, startyl, startyr, width, height]
            var currFish = getFish();
            var yPos;
            if (fishesMove[i] == 'l') {
                yPos = currFish[2];
            }
            else {
                yPos = currFish[3];
            }

            drawImage(fishSpriteSheet, currFish[1], yPos, currFish[4], currFish[5], fishes[i][0], fishes[i][1], currFish[4], currFish[5]);
        }

        for (var i = 0; i < school.length; i++) {
            destPos = i + fishes.length;
            school[i] = swimTogether(destPos, school[i][0], school[i][1], school[i][2]);
            ctx.fillStyle = schoolColor;
            drawSquares(school[i][0], school[i][1], school[i][2]);
        }

        for (var i = 0; i < plants.length; i++) {
            ctx.fillStyle = plantColor;
            drawRectangles(plants[i][0], plants[i][1], plants[i][2]);
        }
    }

    function refresh() {
        fishes = [];
        school = [];
        plants = [];

        numFish = getRandomIntRange(3, 15);
        numPlants = getRandomIntRange(5, 10);
        init();
    }

    // DRAW

    function draw() {
        var myGameArea = document.getElementById("myCanvas");
        return myGameArea;
    }

    function drawSquares(x, y, z) {
        ctx.fillRect(x, y, 50, 50);
    }

    function drawRectangles(x, y, z) {
        ctx.fillRect(x, y, 50, 100);
    }

    function drawImage(img, sx, sy, sw, sh, dx, dy, dw, dh) {
        ctx.drawImage(img, sx, sy, sw, sh, dx, dy, dw, dh);
    }

    function drawBackground() {
        // Create gradient
        var grd = ctx.createLinearGradient(0, 0, 0, 300);
        grd.addColorStop(0, "blue");
        grd.addColorStop(1, "darkblue");

        // Fill with gradient
        ctx.fillStyle = grd;
        ctx.fillRect(0, 0, canvasWidth, canvasHeight);
    }

    function checkDestination(xd, yd, zd, xc, yc, zc, schooling) {
        var vector3Dest = [xd, yd, zd];
        var vector3Curr = [xc, yc, zc];
        if (vector3Dest[0] == 0
            && vector3Dest[1] == 0
            && vector3Dest[2] == 0) {
            vector3Dest = setDestination(schooling);
        }

        if (vector3Curr[0] == vector3Dest[0]
            && vector3Curr[1] == vector3Dest[1]) {
            vector3Dest = setDestination(schooling);
        }

        return vector3Dest;
    }

    function changeExhibit(partialViewToInsert) {
        exhibitType = partialViewToInsert;
        refresh();
    }

    // *******************
    // GET AND SET
    // *******************

    // GET

    function getContext() {
        if (myGameArea.getContext) {
            ctx = myGameArea.getContext('2d');
        }
        return ctx;
    }

    function getMoveType(name){
        if (name == "Shark"
            || name == "Whale"
            || name == "Swordfish"
            || name == "Manatees"
            || name == "Giant Squid") {
            // swim
        }
        else if (name == "Tuna"
            || name == "Clownfish"
            || name == "Jellyfish"
            || name == "Seals"
            || name == "Walruses"
            || name == "Dolphins") {
            // swim together
        }
        else if (name == "Stingray"
            || name == "Ocotopus"
            || name == "Seahorse") {
            // swim floor
        }
        else {
            // Swim None
        }
    }

    function getFish(name) {
        var sprite;
        switch (name) {
            // [name, startx, startyl, startyr, width, height]
            case "Shark":
                sprite = ["Shark", 250, 250, 0, 250, 150];
                break;
            case "Swordfish":
                sprite = ["Swordfish", 700, 250, 0, 250, 100];
                break;
            case "Tuna":
                sprite = ["Tuna", 500, 350, 100, 150, 50];
                break;
            case "Clownfish":
                sprite = ["Clownfish", 850, 350, 100, 100, 50];
                break;
            case "Stingray":
                sprite = ["Stingray", 350, 400, 150, 100, 100];
                break;
            case "Jellyfish":
                sprite = ["Jellyfish", 450, 400, 150, 100, 100];
                break;
            case "Eels":
                sprite = ["Eels", 950, 350, 100, 100, 50];
                break;
            case "Seahorse":
                sprite = ["Seahorse", 950, 400, 150, 100, 100];
                break;
            case "Whales":
                sprite = ["Whales", 0, 250, 0, 250, 150];
                break;
            case "Seals":
                sprite = ["Seals", 650, 350, 100, 200, 50];
                break;
            case "Walruses":
                sprite = ["Walruses", 500, 250, 0, 200, 100];
                break;
            case "Dolphins":
                sprite = ["Dolphins", 950, 250, 0, 250, 100];
                break;
            case "Manatees":
                sprite = ["Manatees", 150, 400, 150, 200, 100];
                break;
            case "Ocotopus":
                sprite = ["Ocotopus", 0, 400, 150, 150, 100];
                break;
            case "Giant Squid":
                sprite = ["Giant Squid", 850, 400, 150, 100, 100];
                break;
            case "Oysters":
                sprite = ["Oysters", 550, 400, 150, 100, 100];
                break;
            default:
                sprite = ["Clownfish", 850, 350, 100, 100, 50];
                break;
        }
        return sprite;
    }

    function getRandomIntRange(min, max) {
        return Math.floor((Math.random() * (max - min)) + min);
    }

    // SET

    function setDestination(schooling) {
        vector3Dest = [0, 0, 0];
        var screenWidthMax;
        var screenHeightMax;
        var screenDepthMax = 15;
        var screenWidthMin;
        var screenHeightMin;
        var screenDepthMin = 0;

        if (!schooling) {
            screenWidthMax = 720;
            screenHeightMax = 480;
            screenWidthMin = 0;
            screenHeightMin = 0;
        }
        else {
            screenWidthMax = vector3Destinations[fishes.length][0] + boundary;
            screenHeightMax = vector3Destinations[fishes.length][1] + boundary;
            screenWidthMin = vector3Destinations[fishes.length][0] - boundary;
            screenHeightMin = vector3Destinations[fishes.length][1] - boundary;
        }
        vector3Dest[0] = getRandomIntRange(screenWidthMin, screenWidthMax);
        vector3Dest[1] = getRandomIntRange(screenHeightMin, screenHeightMax);
        // Determine which layer the fish will swim on
        vector3Dest[2] = getRandomIntRange(screenDepthMin, screenDepthMax);

        return vector3Dest;
    }

    function setPlantDestination() {
        vector3Dest = [0, 0, 0];
        var screenWidthMax;
        var screenHeightMax;
        var screenDepthMax = 15;
        var screenWidthMin;
        var screenHeightMin;
        var screenDepthMin = 0;

        screenWidthMax = canvasWidth;
        screenHeightMax = canvasHeight;
        screenWidthMin = 0;
        screenHeightMin = canvasHeight * 0.8;

        vector3Dest[0] = getRandomIntRange(screenWidthMin, screenWidthMax);
        vector3Dest[1] = getRandomIntRange(screenHeightMin, screenHeightMax);
        // Determine which layer the fish will swim on
        vector3Dest[2] = getRandomIntRange(screenDepthMin, screenDepthMax);

        return vector3Dest;
    }

    function setRndVector3() {
        var vector3 = [getRandomIntRange(0, canvasWidth), getRandomIntRange(0, canvasHeight), getRandomIntRange(-15, -1)];

        return vector3;
    }

    function setVector3Current(x, y, z) {
        vector3Current[0] = x;
        vector3Current[1] = y;
        vector3Current[2] = z;
    }

    // *******************
    // MOVEMENT & PLACEMENT
    // *******************

    // Applies to Shark, Whale, Swordfish, Manatees, squid
    function swim(i, x, y, z) {
        vector3Current = [x, y, z];
        //Check if at/near destination before moving
        vector3Destinations[i] = checkDestination(vector3Destinations[i][0], vector3Destinations[i][1], vector3Destinations[i][2], vector3Current[0], vector3Current[1], vector3Current[2])
        vector3Current = basicMove(i, vector3Destinations[i][0], vector3Destinations[i][1], vector3Destinations[i][2], vector3Current[0], vector3Current[1], vector3Current[2]);

        return vector3Current;
    }

    // Applies to Tuna, Clownfish, jellyfish, seals, walruses, dolphins
    function swimTogether(i, x, y, z) {
        vector3Current = [x, y, z];
        //Check if at/near destination before moving if lead fish
        if (i == fishes.length) {
            vector3Destinations[i] = checkDestination(vector3Destinations[i][0], vector3Destinations[i][1], vector3Destinations[i][2], vector3Current[0], vector3Current[1], vector3Current[2], false);
        }
        else {
            vector3Destinations[i] = checkDestination(vector3Destinations[i][0], vector3Destinations[i][1], vector3Destinations[i][2], vector3Current[0], vector3Current[1], vector3Current[2], true);
        }
        vector3Current = basicMove(i, vector3Destinations[i][0], vector3Destinations[i][1], vector3Destinations[i][2], vector3Current[0], vector3Current[1], vector3Current[2]);

        return vector3Current;
    }

    function basicMove(i, xd, yd, zd, xc, yc, zc) {
        vector3Current = [xc, yc, zc];

        // Swim right
        vector3Current = swimRight(i, vector3Current[0], vector3Current[1], vector3Current[2]);

        // Swim left
        vector3Current = swimLeft(i, vector3Current[0], vector3Current[1], vector3Current[2]);

        // Swim down
        vector3Current = swimDown(i, vector3Current[0], vector3Current[1], vector3Current[2]);

        // Swim up
        vector3Current = swimUp(i, vector3Current[0], vector3Current[1], vector3Current[2]);

        return vector3Current;
    }

    // Applies to stingray, octopus, seahorse
    function swimFloor(i, x, y, z) {
        vector3Current = [xc, yc, zc];
        // Swim right
        vector3Current = swimRight(i, vector3Current[0], vector3Current[1], vector3Current[2]);

        // Swim left
        vector3Current = swimLeft(i, vector3Current[0], vector3Current[1], vector3Current[2]);

        return vector3Current;
    }

    // Applies to Eels, oysters
    function swimNone(i, x, y, z) {
        vector3Current = [xc, yc, zc];

        return vector3Current;
    }

    function swimLeft(i, xc, yc, zc) {
        vector3Current = [xc, yc, zc];
        if (vector3Current[0] > vector3Destinations[i][0]) {
            vector3Current[0] -= MoveSpeed;
            fishesMove[i] = direction[0];
        }
        return vector3Current;
    }

    function swimRight(i, xc, yc, zc) {
        vector3Current = [xc, yc, zc];
        if (vector3Current[0] < vector3Destinations[i][0]) {
            vector3Current[0] += MoveSpeed;
            fishesMove[i] = direction[1];
        }
        return vector3Current;
    }

    function swimUp(i, xc, yc, zc) {
        vector3Current = [xc, yc, zc];
        if (vector3Current[1] > vector3Destinations[i][1]) {
            vector3Current[1] -= MoveSpeed;
        }
        return vector3Current;
    }

    function swimDown(i, xc, yc, zc) {
        vector3Current = [xc, yc, zc];
        if (vector3Current[1] < vector3Destinations[i][1]) {
            vector3Current[1] += MoveSpeed;
        }
        return vector3Current;
    }
</script>
